<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sorc</title>
</head>
<body style="margin : 0; padding: 0">
<canvas id="canvas" width="1138" height="768"></canvas>
<script>
    class Bezier {

        p0;
        p1;
        p2;
        step;

        ax;
        ay;
        bx;
        by;

        A;
        B;
        C;

        total_length;

        init(oPoint0, oPoint1, oPoint2, iSpeed) {
            this.p0 = oPoint0;
            this.p1 = oPoint1;
            this.p2 = oPoint2;

            this.ax = this.p0.x - 2 * this.p1.x + this.p2.x;
            this.ay = this.p0.y - 2 * this.p1.y + this.p2.y;
            this.bx = 2 * this.p1.x - 2 * this.p0.x;
            this.by = 2 * this.p1.y - 2 * this.p0.y;

            this.A = 4 * (this.ax * this.ax + this.ay * this.ay);
            this.B = 4 * (this.ax * this.bx + this.ay * this.by);
            this.C = this.bx * this.bx + this.by * this.by;

            this.total_length = this.length(1);
            this.step = Math.floor(this.total_length / iSpeed);

            if (this.total_length % iSpeed > iSpeed / 2) this.step++;

            return this.step;
        };

        speed(t) {
            return Math.sqrt(this.A * t * t + this.B * t + this.C);
        };

        length(t) {
            let temp1 = Math.sqrt(this.C + t * (this.B + this.A * t));
            let temp2 = (2 * this.A * t * temp1 + this.B * (temp1 - Math.sqrt(this.C)));
            let temp3 = Math.log(this.B + 2 * Math.sqrt(this.A) * Math.sqrt(this.C));
            let temp4 = Math.log(this.B + 2 * this.A * t + 2 * Math.sqrt(this.A) * temp1);
            let temp5 = 2 * Math.sqrt(this.A) * temp2;
            let temp6 = (this.B * this.B - 4 * this.A * this.C) * (temp3 - temp4);

            return (temp5 + temp6) / (8 * Math.pow(this.A, 1.5));
        };

        invertL(t, l) {
            let t1 = t;
            let t2;
            do {
                t2 = t1 - (this.length(t1) - l) / this.speed(t1);
                if (Math.abs(t1 - t2) < 0.000001) break;
                t1 = t2;
            } while (true);
            return t2;
        };

        point(x, y) {
            return {x: x, y: y};
        }

        getAnchorPoint(nIndex) {
            if (nIndex >= 0 && nIndex <= this.step) {
                let t = nIndex / this.step;
                let l = t * this.total_length;
                t = this.invertL(t, l);

                let xx = (1 - t) * (1 - t) * this.p0.x + 2 * (1 - t) * t * this.p1.x + t * t * this.p2.x;
                let yy = (1 - t) * (1 - t) * this.p0.y + 2 * (1 - t) * t * this.p1.y + t * t * this.p2.y;

                let Q0 = this.point((1 - t) * this.p0.x + t * this.p1.x, (1 - t) * this.p0.y + t * this.p1.y);
                let Q1 = this.point((1 - t) * this.p1.x + t * this.p2.x, (1 - t) * this.p1.y + t * this.p2.y);

                let dx = Q1.x - Q0.x;
                let dy = Q1.y - Q0.y;
                let radians = Math.atan2(dy, dx);
                let degrees = radians * 180 / Math.PI;
                return {x: xx, y: yy, dg: degrees};
            } else {
                return [];
            }
        };
    }


    let obj = [
        {"x": -30, "y": 33}, {"x": 0, "y": 34}, {"x": 52, "y": 35}, {"x": 104, "y": 36},
        {"x": 156, "y": 37}, {"x": 209, "y": 38}, {"x": 260, "y": 39}, {"x": 312, "y": 44},
        {"x": 364, "y": 47}, {"x": 416, "y": 50}, {"x": 467, "y": 54}, {"x": 517, "y": 61},
        {"x": 570, "y": 66}, {"x": 622, "y": 74}, {"x": 671, "y": 83}, {"x": 723, "y": 96},
        {"x": 772, "y": 109}, {"x": 820, "y": 128}, {"x": 865, "y": 152}, {"x": 910, "y": 179},
        {"x": 948, "y": 212}, {"x": 983, "y": 252}, {"x": 1008, "y": 294}, {"x": 1021, "y": 343},
        {"x": 1024, "y": 396}, {"x": 1018, "y": 447}, {"x": 1001, "y": 493}, {"x": 980, "y": 535},
        {"x": 950, "y": 580}, {"x": 914, "y": 614}, {"x": 872, "y": 642}, {"x": 824, "y": 667},
        {"x": 776, "y": 683}, {"x": 728, "y": 698}, {"x": 678, "y": 711}, {"x": 627, "y": 718},
        {"x": 575, "y": 724}, {"x": 522, "y": 729}, {"x": 471, "y": 731}, {"x": 419, "y": 733},
        {"x": 366, "y": 734}, {"x": 315, "y": 733}, {"x": 264, "y": 733}, {"x": 212, "y": 729},
        {"x": 163, "y": 723}, {"x": 112, "y": 710}, {"x": 73, "y": 676}, {"x": 56, "y": 630},
        {"x": 46, "y": 580}, {"x": 44, "y": 527}, {"x": 43, "y": 475}, {"x": 42, "y": 422},
        {"x": 42, "y": 371}, {"x": 45, "y": 319}, {"x": 49, "y": 267}, {"x": 56, "y": 217},
        {"x": 68, "y": 166}, {"x": 104, "y": 123}, {"x": 155, "y": 112}, {"x": 206, "y": 112},
        {"x": 258, "y": 113}, {"x": 310, "y": 114}, {"x": 362, "y": 119}, {"x": 412, "y": 122},
        {"x": 465, "y": 128}, {"x": 517, "y": 135}, {"x": 568, "y": 144}, {"x": 618, "y": 154},
        {"x": 669, "y": 167}, {"x": 717, "y": 186}, {"x": 760, "y": 207}, {"x": 799, "y": 246},
        {"x": 828, "y": 284}, {"x": 847, "y": 333}, {"x": 853, "y": 384}, {"x": 845, "y": 436},
        {"x": 827, "y": 484}, {"x": 797, "y": 525}, {"x": 760, "y": 563}, {"x": 718, "y": 591},
        {"x": 672, "y": 612}, {"x": 624, "y": 629}, {"x": 572, "y": 638}, {"x": 519, "y": 646},
        {"x": 468, "y": 651}, {"x": 417, "y": 654}, {"x": 364, "y": 656}, {"x": 313, "y": 653},
        {"x": 260, "y": 646}, {"x": 209, "y": 638}, {"x": 155, "y": 614}, {"x": 144, "y": 567},
        {"x": 134, "y": 518}, {"x": 127, "y": 464}, {"x": 125, "y": 413}, {"x": 127, "y": 361},
        {"x": 131, "y": 308}, {"x": 146, "y": 260}, {"x": 186, "y": 220}, {"x": 235, "y": 206},
        {"x": 288, "y": 202}, {"x": 340, "y": 201}, {"x": 391, "y": 204}, {"x": 443, "y": 209},
        {"x": 492, "y": 219}, {"x": 540, "y": 235}, {"x": 589, "y": 257}, {"x": 626, "y": 289},
        {"x": 653, "y": 334}, {"x": 664, "y": 385}, {"x": 657, "y": 435}, {"x": 630, "y": 482},
        {"x": 594, "y": 518}, {"x": 546, "y": 538}, {"x": 494, "y": 545}, {"x": 442, "y": 551},
        {"x": 392, "y": 555}, {"x": 340, "y": 555}, {"x": 310, "y": 554}, {"x": 279, "y": 555},






        /*{"x": 264, "y": 277}, {"x": 269, "y": 252},*/
    ];

    let bezierArr = [];
    document.addEventListener('click', (eo) => {
        console.log(eo.clientX, eo.clientY)
    });

    let canvas = document.getElementById('canvas');
    let context = canvas.getContext('2d');
    let image = new Image();
    image.src = './storage/levels/1.jpg';
    context.drawImage(image, 0, 0, 1138, 768);

    function point(x, y) {
        return {x: x, y: y};
    }

    function curve() {
        let mapCurve = obj;

        let bezier = new Bezier();

        for (let i = 0; i < mapCurve.length - 2; ++i) {
            let p0 = (i === 0)
                ? point(mapCurve[0].x, mapCurve[0].y)
                : point((mapCurve[i].x + mapCurve[i + 1].x) / 2, (mapCurve[i].y + mapCurve[i + 1].y) / 2);
            let p1 = point(mapCurve[i + 1].x, mapCurve[i + 1].y);
            let p2 = (i <= mapCurve.length - 4)
                ? point((mapCurve[i + 1].x + mapCurve[i + 2].x) / 2, (mapCurve[i + 1].y + mapCurve[i + 2].y) / 2)
                : point(mapCurve[i + 2].x, mapCurve[i + 2].y);

            let steps = bezier.init(p0, p1, p2, 1);

            for (let m = 1; m <= steps; ++m) {
                let data = bezier.getAnchorPoint(m);

                bezierArr.push(data);
            }
        }
    }

    curve();


    let count = 0;
    if (count === 0) {
        context.moveTo(bezierArr[0].x, bezierArr[0].y);
        count++;
    }

    for (let i = 1; i < bezierArr.length - 1; i++) {
        context.lineTo(bezierArr[i].x, bezierArr[i].y);
        context.lineWidth = 1;
        context.strokeStyle = 'yellow';
        context.stroke();
    }

    let json = JSON.stringify(bezierArr);
    /*console.log(json)*/
</script>
</body>
</html>